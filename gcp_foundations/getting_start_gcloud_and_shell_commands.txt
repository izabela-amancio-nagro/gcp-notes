Come√ßando no Cloud Shell e comandos gcloud

Lista o nome da conta ativa:
$ gcloud auth list

Define a conta ativa
$ gcloud config set account `ACCOUNT`

Lista o ID do projeto
$ gcloud config list Project

Ap√≥s o Cloud Shell ser ativado, voc√™ pode usar a linha de comando para invocar a gcloud ferramenta Cloud SDK ou outras ferramentas dispon√≠veis na inst√¢ncia da m√°quina virtual.

--

Configura√ß√£o de ambiente - Regi√µes e Zonas

- Inst√¢ncias de m√°quina virtual e discos persistentes vivem em uma zona. 

- Se voc√™ quiser anexar um disco persistente a uma inst√¢ncia de m√°quina virtual, ambos os recursos devem estar na mesma zona. 

- Para atribuir um endere√ßo IP est√°tico a uma inst√¢ncia, a inst√¢ncia deve estar na mesma regi√£o que o endere√ßo IP est√°tico.

Define a regi√£o
$ gcloud config set compute/region REGION

Para visualizar a regi√£o definida
$ gcloud config get-value compute/region

Define a zona
$ gcloud config set compute/zone ZONE

Para visualizar a zona definida
$ gcloud config get-value compute/zone

--

Informa√ß√µes do projeto
Exemplo: metadados de zona e regi√£o

Para visualizar o ID do projeto
$ gcloud config get-value Project

Para ver detalhes sobre o projeto
$ gcloud compute project-info describe --project $(gcloud config get-value project)

--

Configura√ß√£o de vari√°veis de ambiente

Cria√ß√£o de vari√°veis para armazenar o ID do projeto e a zona

$ export PROJECT_ID=$(gcloud config get-value project)
$ export ZONE=$(gcloud config get-value compute/zone)

Para verificar se suas vari√°veis ‚Äã‚Äãforam definidas corretamente
$ echo -e "PROJECT ID: $PROJECT_ID\nZONE: $ZONE"

--

Cria√ß√£o de VM com a gcloud

Para criar a VM
$ gcloud compute instances create gcelab2 --machine-type e2-medium --zone $ZONE

üìù Detalhes do comando

‚Ä¢ gcloud compute: permite que voc√™ gerencie seus recursos do Compute Engine em um formato mais simples que a API do Compute Engine.

‚Ä¢ instances create: cria uma nova inst√¢ncia.

‚Ä¢ gcelab2: √© o nome da VM.

‚Ä¢ --machine-type: sinalizador que especifica o tipo de m√°quina como e2-medium .

‚Ä¢ --zone: sinalizador especifica onde a VM √© criada.

Se --zone for omitida a gcloud pode a zona com base em propriedades padr√£o. Outras configura√ß√µes de inst√¢ncia necess√°rias, como machine type e image, s√£o definidas para valores padr√£o se n√£o forem especificadas no comando create.

--

Explorando comandos do gcloud


Para ajuda com os comandos gcloud
$ gcloud -h   OU
$ gcloud config --help   OU
$ gcloud help config

GLOBAL FLAGS (substituem quaisquer valores definidos nas propriedades do SDK): https://cloud.google.com/sdk/gcloud/reference/

Para ver lista de configura√ß√µes em seu ambiente
$ gcloud config list

Para ver todas propriedades e suas configura√ß√µes
$ gcloud config list --all

Para listar componentes
$ gcloud components list



Filtros na linha de comando gcloud

Lista a inst√¢ncia de computa√ß√£o dispon√≠vel no projeto
$ gcloud compute instances list

Para listar a VM gcelab2 (mostrar apenas as informa√ß√µes que correspondem aos crit√©rios)
$ gcloud compute instances list --filter="name=('gcelab2')"

Lista as regras de firewall no projeto
$ gcloud compute firewall-rules list

Exemplo de filtro para lista as regras de firewall para a rede padr√£o
$ gcloud compute firewall-rules list --filter="network='default'"

--

Conectando com a inst√¢ncia da VM

Para se conectar √† VM com SSH
$ gcloud compute ssh gcelab2 --zone $ZONE
Confirme apertando Y
Passphrase opcional (apertar enter 2x para deixar vazio)


SA√çDA:
O prompt agora diz algo semelhante a sa_107021519685252337470@gcelab2 .

‚Ä¢ A refer√™ncia antes do @ indica a conta que est√° sendo usada.
‚Ä¢ Depois do sinal @ indica a m√°quina host que est√° sendo acessada.

Instala o servidor web nginx na m√°quina virtual
$ sudo apt install -y nginx

Para desconectar do SSH e sair do shell remoto
$ exit

--

Atualizando o firewall

Lista as regras de firewall no projeto
$ gcloud compute firewall-rules list

O servidor web nginx espera se comunicar em tcp:80. Para que a comunica√ß√£o funcione, √© preciso:

‚Ä¢ Adicionar uma tag √† m√°quina virtual gcelab2
$ gcloud compute instances add-tags gcelab2 --tags http-server,https-server

‚Ä¢ Adicionar uma regra de firewall para tr√°fego http
$ gcloud compute firewall-rules create default-allow-http --direction=INGRESS --priority=1000 --network=default --action=ALLOW --rules=tcp:80 --source-ranges=0.0.0.0/0 --target-tags=http-server

Novamente vamos listar as regras de firewall no projeto, incluindo um filtro para a tcp permitida
$ gcloud compute firewall-rules list --filter=ALLOW:'80'

Verifica se a comunica√ß√£o √© poss√≠vel entre http e a m√°quina virtual
$ curl http://$(gcloud compute instances list --filter=name:gcelab2 --format='value(EXTERNAL_IP)')

--

Visualizando os logs do sistema

Visualizar os logs dispon√≠veis no sistema
$ gcloud logging logs list

FILTROS - Exemplos: 

Visualizar os logs relacionados aos recursos de computa√ß√£o
$ gcloud logging logs list --filter="compute"

Ler os logs relacionados ao tipo de recurso de gce_instance
$ gcloud logging read "resource.type=gce_instance" --limit 5

Ler os logs de uma VM espec√≠fica
$ gcloud logging read "resource.type=gce_instance AND labels.instance_name='gcelab2'" --limit 5